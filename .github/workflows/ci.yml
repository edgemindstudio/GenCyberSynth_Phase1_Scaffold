# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke-all:
    name: Smoke tests (all adapters)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.ci.txt
            requirements.txt

      - name: Install dependencies (CI-lean if available)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.ci.txt ]; then
            pip install -r requirements.ci.txt
          else
            pip install -r requirements.txt
          fi

      - name: Repo setup (creates summaries dir, etc.)
        run: make setup

      - name: Run smoke-all (tiny synth+eval)
        run: make smoke-all

      - name: Build preview grids
        run: make grids

      - name: Upload raw artifacts from smoke
        uses: actions/upload-artifact@v4
        with:
          name: phase1-artifacts-raw
          path: artifacts
          if-no-files-found: error
          retention-days: 7

      - name: Upload preview grids
        uses: actions/upload-artifact@v4
        with:
          name: preview-grids
          path: artifacts/preview_grids/*.png
          if-no-files-found: warn
          retention-days: 7

  validate-jsonl:
    name: Consolidate & validate JSONL/CSV
    runs-on: ubuntu-latest
    needs: smoke-all
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install minimal build deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.ci.txt || true
          pip install jsonschema==4.23.0 pandas==2.2.3

      - name: Download raw artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase1-artifacts-raw
          path: phase1-artifacts-raw

      # Optional: show what we actually downloaded for easier debugging
      - name: Inspect workspace (debug)
        run: |
          set -x
          ls -la
          ls -la phase1-artifacts-raw || true
          find phase1-artifacts-raw -maxdepth 3 -type f | sed 's/^/RAW: /' || true

      # If the artifact was uploaded as a folder, nothing to flatten is required.
      # We now consolidate using a robust script that handles all layouts.
      - name: Build consolidated JSONL (schema-aware)
        run: |
          bash scripts/build_jsonl.sh

      - name: Build mini CSV table (JSONL -> CSV)
        run: python scripts/jsonl_to_csv.py

      # Validate the JSONL we just built (donâ€™t re-glob the raw summaries).
      - name: Validate JSON lines format (schema optional, reset to fresh)
        run: |
          python - <<'PY'
          import json, pathlib, sys
          p = pathlib.Path("artifacts/summaries/phase1_summaries.jsonl")
          assert p.exists(), f"Missing JSONL: {p}"
          n = 0
          with p.open() as f:
            for i, line in enumerate(f, 1):
              json.loads(line)
              n = i
          print(f"OK: validated {n} JSON lines in {p}")
          PY

      - name: Upload consolidated outputs
        uses: actions/upload-artifact@v4
        with:
          name: phase1-summaries
          path: |
            artifacts/summaries/phase1_summaries.jsonl
            artifacts/phase1_scores.csv
          if-no-files-found: error
          retention-days: 30

  demo-smoke:
    name: Demo import & grid presence
    runs-on: ubuntu-latest
    needs: smoke-all
    steps:
      - uses: actions/checkout@v4

      - name: Download preview grids artifact
        uses: actions/download-artifact@v4
        with:
          name: preview-grids
          path: artifacts/preview_grids

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install minimal runtime for demo
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.ci.txt || pip install gradio==5.47.0

      - name: Check demo import and grids exist
        run: |
          python - <<'PY'
          from pathlib import Path
          import importlib.util
          assert Path("demo/app.py").exists(), "demo/app.py missing"
          spec = importlib.util.spec_from_file_location("demo_app", "demo/app.py")
          mod = importlib.util.module_from_spec(spec); spec.loader.exec_module(mod)
          art = Path("artifacts/preview_grids")
          pngs = list(art.glob("*_grid.png"))
          assert pngs, f"No preview grids in {art}"
          print(f"OK: {len(pngs)} grid(s) found")
          PY

      - name: Upload demo-smoke artifacts
        uses: actions/upload-artifact@v4
        with:
          name: demo-smoke-artifacts
          path: artifacts/preview_grids/*.png
          if-no-files-found: warn
          retention-days: 7
